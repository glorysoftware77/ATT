default_platform(:ios)

platform :ios do
  desc "Update dependencies, build, and deploy to TestFlight"
  lane :deploy do
    # Step 1: Update Flutter to the latest stable version
    sh "flutter upgrade"
    
    # Step 2: Ensure Flutter dependencies are fetched
    sh "flutter pub get"
    
    # Step 3: Upgrade dependencies within constraints (optional)
    sh "flutter pub upgrade --major-versions"

    # Step 4: Build the Flutter app for iOS
    sh "flutter build ios --release"

    # Step 5: Increment the build number
    increment_build_number

    # Step 6: Run pod install to install iOS dependencies
    sh "pod install"

    # Step 7: Build the app using Fastlane
    build_ios_app(
      scheme: "Runner", # Change this if your scheme name is different
      export_method: "app-store", # Change this if your export method is different
      export_xcargs: "-allowProvisioningUpdates", # Allow updates to provisioning profiles
      build_path: "build", # Path to save the build
      signing_style: "manual", # Use manual signing
      team_id: "6XJTVN2FYA", # Your Apple Developer Team ID
      output_directory: "./output", # Where to output the IPA file
      configuration: "Release" # Change if you have a custom configuration
    )

    # Step 8: Upload to TestFlight
    upload_to_testflight(
      skip_waiting_for_build_processing: true, # Skip waiting for build processing
      app_identifier: "com.glory.activetraveltours", # Your app identifier
      distribute_external: true # Distribute to external testers
    )
  end
end
