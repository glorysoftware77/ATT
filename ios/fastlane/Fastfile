default_platform(:ios)

platform :ios do
  desc "Build and deploy to TestFlight"
  lane :deploy do
    # Ensure Flutter dependencies are fetched
    sh "flutter pub get"

    # Build the Flutter app for iOS
    sh "flutter build ios --release"

    # Increment the build number
    increment_build_number

    # Run pod install to install iOS dependencies
    sh "pod install"

    # Build the app using Fastlane
    build_ios_app(
      scheme: "Runner", # Change this if your scheme name is different
      export_method: "app-store", # Change this if your export method is different
      export_xcargs: "-allowProvisioningUpdates", # Allow updates to provisioning profiles
      build_path: "build", # Path to save the build
      signing_style: "manual", # Use manual signing
      team_id: "6XJTVN2FYA", # Your Apple Developer Team ID
      output_directory: "./output", # Where to output the IPA file
      configuration: "Release" # Change if you have a custom configuration
    )
    
    # Upload to TestFlight
    upload_to_testflight(
      skip_waiting_for_build_processing: true, # Skip waiting for build processing
      app_identifier: "com.glory.activetraveltours", # Your app identifier
      distribute_external: true # Distribute to external testers
    )
  end
end
